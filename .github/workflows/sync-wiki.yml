name: Sync docs to Wiki

on:
  push:
    branches: [main]
    paths: ['docs/**']
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync-wiki:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout main repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Checkout wiki
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository_owner }}/${{ github.event.repository.name }}.wiki
          path: wiki-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Copy docs to wiki
        run: |
          cp -r docs/. wiki-repo/

      - name: Convert links for wiki (strip .md from relative links)
        run: |
          python3 - <<'PY'
          from __future__ import annotations
          
          import pathlib
          import re
          
          root = pathlib.Path("wiki-repo")
          md_files = list(root.rglob("*.md"))
          
          # GitHub wiki prefers links without the .md extension:
          #   [Interstitial](Interstitial-ads) instead of [Interstitial](Interstitial-ads.md)
          #
          # Only rewrite *relative* markdown links:
          # - don't touch http(s)://, mailto:, anchors (#...), or absolute paths (/...)
          # - preserve optional #fragment anchors
          pattern = re.compile(
              r"\]\("
              r"(?!https?://)"
              r"(?!mailto:)"
              r"(?!#)"
              r"(?!/)"
              r"([^) \t\r\n]+?)"
              r"\.md"
              r"(\#[^)]+)?"
              r"\)"
          )
          
          for path in md_files:
              text = path.read_text(encoding="utf-8")
              new_text = pattern.sub(lambda m: f"]({m.group(1)}{m.group(2) or ''})", text)
              if new_text != text:
                  path.write_text(new_text, encoding="utf-8")
          PY

      - name: Commit and push wiki
        run: |
          cd wiki-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to push"
          else
            git commit -m "Sync docs from main branch"
            git push
          fi
